# Система нумерации закрытых заявок на вывод

## Что изменилось

Теперь нумерация заявок работает по-новому:

- **В чате админов** (`@kirbyvivodstars`) - заявки обрабатываются с ID из базы данных (как раньше)
- **В чате платежей** (`@kirbystarspayments`) - заявки показываются с **последовательными номерами закрытия**

## Преимущества новой системы

1. **Порядковая нумерация** - заявки в платежном чате всегда идут по порядку (#438, #439, #440...)
2. **Независимость от порядка обработки** - админы могут закрывать заявки в любом порядке
3. **Отсутствие пропусков** - нет пропущенных номеров в платежном чате

## Как это работает

1. Пользователь создает заявку на вывод → получает обычный ID (например, 1523)
2. Заявка попадает в чат админов с ID #1523
3. Админ одобряет/отклоняет заявку → она получает **номер закрытия** (например, #438)
4. В платежный чат отправляется сообщение с номером закрытия #438

## Команды для настройки

### 1. Миграция базы данных (выполнить один раз)
```bash
npm run migrate-closure
```
Добавляет поле `closure_number` и создает последовательность.

### 2. Установка начального номера (выполнить один раз)
```bash
npm run set-closure-number
```
Устанавливает начальное значение так, чтобы следующая заявка имела номер 438.

## Структура базы данных

Добавлено новое поле в таблицу `withdrawal_requests`:
- `closure_number` - порядковый номер закрытия заявки (присваивается только при approve/reject)

Создана новая последовательность:
- `withdrawal_closure_seq` - генерирует порядковые номера для закрытых заявок

## Изменения в коде

### database.js
- Добавлен метод `setWithdrawalClosureStartNumber()` 
- Изменен метод `processWithdrawal()` - теперь присваивает `closure_number`

### index.js  
- Изменена функция `handleWithdrawalAction()` - использует `closure_number` для платежного чата

## Проверка работы

После миграции и установки номера:
1. Создайте тестовую заявку на вывод
2. Одобрите её в админском чате
3. Проверьте, что в платежном чате отображается номер #438

## Примечания

- Старые заявки (до миграции) будут иметь `closure_number = NULL`
- Новые заявки получают номер только при закрытии (одобрении/отклонении)
- Последовательность работает автоматически, вмешательство не требуется
