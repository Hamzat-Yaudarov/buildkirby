# –û—Ç—á—ë—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å–ø–æ–Ω—Å–æ—Ä—Å–∫–∏—Ö –∫–∞–Ω–∞–ª–æ–≤

## üö® –ü—Ä–æ–±–ª–µ–º–∞

**–û–ø–∏—Å–∞–Ω–∏–µ**: –°–ø–æ–Ω—Å–æ—Ä—Å–∫–∏–µ –∫–∞–Ω–∞–ª—ã –°–£–©–ï–°–¢–í–£–Æ–¢ –≤ SubGram API, –Ω–æ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –∏—Ö –ù–ï –í–ò–î–ò–¢ –∏ –ù–ï –±–ª–æ–∫–∏—Ä—É–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –≥–ª–∞–≤–Ω–æ–º—É –º–µ–Ω—é –∏ –∫–Ω–æ–ø–∫–∞–º, —Ö–æ—Ç—è –¥–æ–ª–∂–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ —Å–ø–æ–Ω—Å–æ—Ä—Å–∫–∏–µ –∫–∞–Ω–∞–ª—ã.

## üîç –ê–Ω–∞–ª–∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –ø—Ä–∏—á–∏–Ω—ã

### –ì–ª–∞–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞
1. **SubGram API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `status: 'warning'`** ‚Üí —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è `needsSubscription=true`
2. **–ù–û –∫–∞–Ω–∞–ª—ã –ø—Ä–∏—Ö–æ–¥—è—Ç –ø—É—Å—Ç—ã–º–∏** –≤ –ø–æ–ª—è—Ö `additional.sponsors` –∏–ª–∏ `links`
3. **–†–µ–∑—É–ª—å—Ç–∞—Ç**: `needsSubscription=true` –Ω–æ `channelsToSubscribe=[]`
4. **–õ–æ–≥–∏–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏** –±—ã–ª–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π - –ª–∏–±–æ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∞ –±–µ–∑ –∫–∞–Ω–∞–ª–æ–≤, –ª–∏–±–æ –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∞ –≤–æ–æ–±—â–µ

### –ü—É—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å /start ‚Üí smartSubGram.getSubscriptionMessage(userId)
‚îî‚îÄ shouldBlockBotAccess(userId) 
   ‚îî‚îÄ getSubGramState(userId)
      ‚îî‚îÄ subgramAPI.requestSponsors()
         ‚îî‚îÄ processAPIResponse() ‚Üí needsSubscription=true, channelsToSubscribe=[]
```

## ‚úÖ –í–Ω–µ—Å—ë–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤ `getSubGramState()`
**–§–∞–π–ª**: `subgram-smart-handler.js` (—Å—Ç—Ä–æ–∫–∏ 117-169)

**–°–¢–ê–†–ê–Ø –ü–†–û–ë–õ–ï–ú–ù–ê–Ø –õ–û–ì–ò–ö–ê:**
```javascript
if (processedData.needsSubscription) {
    // –í–°–ï–ì–î–ê –±–ª–æ–∫–∏—Ä—É–µ–º, –¥–∞–∂–µ –µ—Å–ª–∏ –∫–∞–Ω–∞–ª–æ–≤ –Ω–µ—Ç
    if (channelsToSubscribe.length > 0) {
        return { shouldBlock: true, channels: channelsToSubscribe };
    } else {
        return { shouldBlock: true, channels: [] }; // ‚ùå –ë–ª–æ–∫–∏—Ä—É–µ–º –±–µ–∑ –∫–∞–Ω–∞–ª–æ–≤
    }
}
```

**–ù–û–í–ê–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê:**
```javascript
if (processedData.needsSubscription) {
    if (channelsToSubscribe.length > 0) {
        // –ï—Å—Ç—å –∫–∞–Ω–∞–ª—ã - –±–ª–æ–∫–∏—Ä—É–µ–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ö
        return { shouldBlock: true, channels: channelsToSubscribe };
    } else {
        // –ö–∞–Ω–∞–ª–æ–≤ –≤ API –Ω–µ—Ç - –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª—ã –≤ –ë–î
        const savedChannels = await db.executeQuery(/*...*/);
        if (savedChannels.rows.length > 0) {
            // –ï—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª—ã - –±–ª–æ–∫–∏—Ä—É–µ–º
            return { shouldBlock: true, channels: savedChannelsFormatted };
        } else {
            // –ù–µ—Ç –Ω–∏ –Ω–æ–≤—ã—Ö, –Ω–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ - –ù–ï –±–ª–æ–∫–∏—Ä—É–µ–º
            return { shouldBlock: false, channels: [] };
        }
    }
}
```

### 2. –£–ª—É—á—à–µ–Ω –ø–∞—Ä—Å–∏–Ω–≥ –æ—Ç–≤–µ—Ç–∞ SubGram API
**–§–∞–π–ª**: `subgram-api.js` (—Å—Ç—Ä–æ–∫–∏ 165-220)

#### –î–æ–±–∞–≤–ª–µ–Ω–æ:
- **–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** —Å—Ç—Ä—É–∫—Ç—É—Ä—ã API –æ—Ç–≤–µ—Ç–∞
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª–µ–π** –¥–ª—è –∫–∞–Ω–∞–ª–æ–≤
- **–£–º–Ω–∞—è –ª–æ–≥–∏–∫–∞ `needsSubscription`** - —Ç–µ–ø–µ—Ä—å `true` —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –∫–∞–Ω–∞–ª—ã:

```javascript
// –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: needsSubscription –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å true —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –∫–∞–Ω–∞–ª—ã
if (result.needsSubscription && result.channelsToSubscribe.length === 0) {
    console.log('[SUBGRAM] WARNING: status=warning but no channels requiring subscription found');
    result.needsSubscription = false; // ‚úÖ –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ª–æ–≥–∏–∫—É
}
```

### 3. –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- `/test_sponsor_blocking` - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
- `/diagnose_sponsors` - –ø–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ:

1. **‚úÖ –ï—Å—Ç—å —Å–ø–æ–Ω—Å–æ—Ä—Å–∫–∏–µ –∫–∞–Ω–∞–ª—ã** ‚Üí –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –∏—Ö –∏ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø
2. **‚úÖ –ù–µ—Ç —Å–ø–æ–Ω—Å–æ—Ä—Å–∫–∏—Ö –∫–∞–Ω–∞–ª–æ–≤** ‚Üí –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –±–æ—Ç—É  
3. **‚úÖ SubGram API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω** ‚Üí –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø (fallback)
4. **‚úÖ –ï—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª—ã** ‚Üí –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –∏—Ö –∏ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
- `/test_sponsor_blocking` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–∫–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
- `/diagnose_sponsors` - –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º
- `/check_smart_state` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

### ‚úÖ –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
1. **–£—Å—Ç—Ä–∞–Ω–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ "–Ω–µ–≤–∏–¥–∏–º—ã—Ö –∫–∞–Ω–∞–ª–æ–≤"** - —Ç–µ–ø–µ—Ä—å —Å–∏—Å—Ç–µ–º–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤–∏–¥–∏—Ç —Å–ø–æ–Ω—Å–æ—Ä—Å–∫–∏–µ –∫–∞–Ω–∞–ª—ã
2. **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ** - –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –µ—Å—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –∫–∞–Ω–∞–ª—ã –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏
3. **–£–ª—É—á—à–µ–Ω–∞ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å** - –Ω–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∫–∞–Ω–∞–ª–æ–≤
4. **–î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞** –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã—è–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º

### üöÄ –ß—Ç–æ —Ç–µ–ø–µ—Ä—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
1. **–ï—Å–ª–∏ –µ—Å—Ç—å —Å–ø–æ–Ω—Å–æ—Ä—Å–∫–∏–µ –∫–∞–Ω–∞–ª—ã** ‚Üí –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –∏—Ö –∏ –¥–æ–ª–∂–µ–Ω –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è
2. **–ï—Å–ª–∏ –∫–∞–Ω–∞–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã** ‚Üí –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –≥–ª–∞–≤–Ω–æ–º—É –º–µ–Ω—é
3. **SubGram –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `warning` –±–µ–∑ –∫–∞–Ω–∞–ª–æ–≤** ‚Üí —Å–∏—Å—Ç–µ–º–∞ –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç `needsSubscription=false`
4. **–ï—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª—ã –≤ –ë–î** ‚Üí –æ–Ω–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

## üîÑ –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã (–Ω–æÔøΩÔøΩ–∞—è)

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç /start
2. –ó–∞–ø—Ä–æ—Å –∫ SubGram API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞–Ω–∞–ª–æ–≤
3. –ü–∞—Ä—Å–∏–Ω–≥ –æ—Ç–≤–µ—Ç–∞:
   - –ï—Å–ª–∏ status='warning' –ù–û –∫–∞–Ω–∞–ª–æ–≤ –Ω–µ—Ç ‚Üí needsSubscription=false
   - –ï—Å–ª–∏ status='warning' –ò –µ—Å—Ç—å –∫–∞–Ω–∞–ª—ã ‚Üí needsSubscription=true
4. –ü—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏—è:
   - –ï—Å–ª–∏ needsSubscription=true –ò –µ—Å—Ç—å –∫–∞–Ω–∞–ª—ã ‚Üí –ë–õ–û–ö–ò–†–û–í–ê–¢–¨
   - –ï—Å–ª–∏ needsSubscription=true –ù–û –∫–∞–Ω–∞–ª–æ–≤ –Ω–µ—Ç ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ
   - –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª—ã ‚Üí –ë–õ–û–ö–ò–†–û–í–ê–¢–¨
   - –ò–Ω–∞—á–µ ‚Üí –†–ê–ó–†–ï–®–ò–¢–¨ –î–û–°–¢–£–ü
5. –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
```

## üìã –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

### –ù–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã:
- `/test_sponsor_blocking` - —Ç–µ—Å—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å–ø–æ–Ω—Å–æ—Ä—Å–∫–∏—Ö –∫–∞–Ω–∞–ª–æ–≤
- `/diagnose_sponsors` - –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º —Å–æ —Å–ø–æ–Ω—Å–æ—Ä—Å–∫–∏–º–∏ –∫–∞–Ω–∞–ª–∞–º–∏

### –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã:
- `/check_smart_state` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —É–º–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
- `/force_refresh_subgram` - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- `/reset_subgram_cache` - –æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –∫–∞–Ω–∞–ª–æ–≤

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:
```
[SMART-SUBGRAM] needsSubscription=true - checking for actual channels
[SMART-SUBGRAM] Channels available: X, toSubscribe: Y
[SMART-SUBGRAM] BLOCKING - found X channels requiring subscription
[SUBGRAM] WARNING: status=warning but no channels requiring subscription found
```

### –ü—Ä–∏–∑–Ω–∞–∫–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã:
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å —Å–ø–æ–Ω—Å–æ—Ä—Å–∫–∏–º–∏ –∫–∞–Ω–∞–ª–∞–º–∏ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–µ–∑ –∫–∞–Ω–∞–ª–æ–≤ –ø–æ–ª—É—á–∞—é—Ç –¥–æ—Å—Ç—É–ø
- ‚úÖ –í –ª–æ–≥–∞—Ö –≤–∏–¥–Ω–æ —Ä–µ–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–Ω–∞–ª–æ–≤
- ‚úÖ –ù–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –±–µ–∑ –∫–∞–Ω–∞–ª–æ–≤

---

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–ü–†–û–ë–õ–ï–ú–ê –†–ï–®–ï–ù–ê**  
**–¢–∏–ø –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: –õ–æ–≥–∏–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏ –ø–∞—Ä—Å–∏–Ω–≥ API  
**–§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã**: `subgram-smart-handler.js`, `subgram-api.js`, `index.js`  
**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –°–ø–æ–Ω—Å–æ—Ä—Å–∫–∏–µ –∫–∞–Ω–∞–ª—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –±–ª–æ–∫–∏—Ä—É—é—Ç –¥–æ—Å—Ç—É–ø –∫–æ–≥–¥–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç
