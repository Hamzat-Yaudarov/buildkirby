# –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´ –ú–ù–û–ñ–ï–°–¢–í–ï–ù–ù–´–• –°–û–û–ë–©–ï–ù–ò–ô –ü–†–ò /START

## üêõ –ü–†–û–ë–õ–ï–ú–ê

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–æ–±—â–∏–ª, —á—Ç–æ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–º–∞–Ω–¥—ã `/start` –Ω–µ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ä–∞–∑—É –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:
- –°–ø–æ–Ω—Å–æ—Ä—Å–∫–∏–µ –∫–∞–Ω–∞–ª—ã
- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é  
- –°–ø–æ–Ω—Å–æ—Ä—Å–∫–∏–µ –∫–∞–Ω–∞–ª—ã (–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ)
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–∞–Ω–∞–ª—ã

## üîç –ù–ê–ô–î–ï–ù–ù–´–ï –ü–†–ò–ß–ò–ù–´

### 1. **–ü—É—Å—Ç–æ–π –¥—É–±–ª–∏—Ä—É—é—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ /start**
```javascript
// –ë–´–õ–û:
bot.onText(/\/start/, () => {}); // –ü—É—Å—Ç–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ - –º–æ–≥ –º–µ—à–∞—Ç—å
bot.onText(/\/start(.*)/, async (msg, match) => { // –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
```

### 2. **–ö–æ–Ω—Ñ–ª–∏–∫—Ç –º–µ–∂–¥—É ÔøΩÔøΩ—Ç–∞—Ä–æ–π –∏ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–∞–º–∏ –ø–æ–¥–ø–∏—Å–æ–∫**
- **–ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞** (subscription-flow-manager.js): –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ `/start`
- **–°—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞** (unified-subscription-check.js): –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ callback'–∞—Ö
- **–°–º–µ—à–∞–Ω–Ω—ã–µ callback'–∏**: –ö–Ω–æ–ø–∫–∏ –º–æ–≥–ª–∏ —Å—Å—ã–ª–∞—Ç—å—Å—è –Ω–∞ —Ä–∞–∑–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã

### 3. **Fallback –∫–Ω–æ–ø–∫–∞ —Å–æ —Å—Ç–∞—Ä—ã–º callback'–æ–º**
```javascript
// –í subscription-flow-manager.js
buttons: [
    [{ text: 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å', callback_data: 'check_subscriptions' }] // –°—Ç–∞—Ä—ã–π callback!
]
```

### 4. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–∞—â–∏—Ç—ã –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –±—ã—Å—Ç—Ä–æ –Ω–∞–∂–∞—Ç—å `/start` –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
- –ù–µ –±—ã–ª–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ —É–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã–µ –∫–æ–º–∞–Ω–¥—ã

## ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### 1. **–£–±—Ä–∞–Ω –¥—É–±–ª–∏—Ä—É—é—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫**
```javascript
// –ë–´–õ–û:
bot.onText(/\/start/, () => {}); // –£–±—Ä–∞–Ω–æ
bot.onText(/\/start(.*)/, async (msg, match) => {

// –°–¢–ê–õ–û:
bot.onText(/\/start(.*)/, async (msg, match) => { // –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
```

### 2. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω fallback callback**
```javascript
// –ë–´–õ–û:
buttons: [
    [{ text: 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å', callback_data: 'check_subscriptions' }]
]

// –°–¢–ê–õ–û:
buttons: [
    [{ text: 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å', callback_data: 'check_sponsors' }] // –ù–æ–≤—ã–π callback
]
```

### 3. **–î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥**
```javascript
// –ó–∞—â–∏—Ç–∞ –æ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö /start –∫–æ–º–∞–Ω–¥
const startProcessing = new Set();

bot.onText(/\/start(.*)/, async (msg, match) => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ª–∏ —É–∂–µ /start –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if (startProcessing.has(userId)) {
        console.log(`[START] Already processing /start for user ${userId}, ignoring duplicate`);
        return;
    }
    
    startProcessing.add(userId);
    
    try {
        // –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
    } finally {
        // –û—á–∏—â–∞–µ–º —Ñ–ª–∞–≥ –æ–±—Ä–∞–±–æ—Ç–∫–∏
        startProcessing.delete(userId);
    }
});
```

### 4. **–£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏**
```javascript
console.log(`[START] Starting subscription check for user ${userId}`);
console.log(`[START] Received stage info: stage=${stageInfo.stage}, allCompleted=${stageInfo.allCompleted}`);
console.log(`[START] Sending subscription message to user ${userId}`);
console.log(`[START] Message sent, returning from /start handler`);
console.log(`[START] Finished processing /start for user ${userId}`);
```

## üéØ –†–ï–ó–£–õ–¨–¢–ê–¢

### –¢–µ–ø–µ—Ä—å –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ:

1. **–¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫** `/start` –∫–æ–º–∞–Ω–¥—ã
2. **–ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è** - –µ—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ —É–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è, –Ω–æ–≤—ã–µ –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è
3. **–ï–¥–∏–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ–¥–ø–∏—Å–æ–∫** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ subscription-flow-manager.js
4. **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ callback'–∏** - –≤—Å–µ –∫–Ω–æ–ø–∫–∏ —Å—Å—ã–ª–∞—é—Ç—Å—è –Ω–∞ –Ω–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
5. **–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –º–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å –∫–∞–∂–¥—ã–π —à–∞–≥ –æ–±—Ä–∞–±–æ—Ç–∫–∏

### –ü—Ä–∏ `/start` —Ç–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –¢–û–õ–¨–ö–û –û–î–ù–û —Å–æ–æ–±—â–µ–Ω–∏–µ:

‚úÖ **–ù–µ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π –Ω–∞ —Å–ø–æ–Ω—Å–æ—Ä–æ–≤** ‚Üí –¢–æ–ª—å–∫–æ —Å–ø–æ–Ω—Å–æ—Ä—Å–∫–∏–µ –∫–∞–Ω–∞–ª—ã  
‚úÖ **–ü–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ —Å–ø–æ–Ω—Å–æ—Ä–æ–≤, –Ω–µ –Ω–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ** ‚Üí –¢–æ–ª—å–∫–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–∞–Ω–∞–ª—ã  
‚úÖ **–ü–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ –≤—Å–µ** ‚Üí –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é  

## üîß –ò–ó–ú–ï–ù–ï–ù–ù–´–ï –§–ê–ô–õ–´

1. **`index.js`**:
   - –£–±—Ä–∞–Ω –ø—É—Å—Ç–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `/start`
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥
   - –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

2. **`subscription-flow-manager.js`**:
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω fallback callback –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π

## üöÄ –ì–û–¢–û–í–û –ö –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Æ

–¢–µ–ø–µ—Ä—å –ø—Ä–∏ –∫–æ–º–∞–Ω–¥–µ `/start` –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏—Ç —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ –Ω—É–∂–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è! üéâ

### –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:
1. **–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** ‚Üí –û–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å–ø–æ–Ω—Å–æ—Ä—Å–∫–∏–º–∏ –∫–∞–Ω–∞–ª–∞–º–∏
2. **–ë—ã—Å—Ç—Ä–æ–µ –Ω–∞–∂–∞—Ç–∏–µ /start** ‚Üí –í—Ç–æ—Ä–æ–µ –Ω–∞–∂–∞—Ç–∏–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è
3. **–ü–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** ‚Üí –û–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≥–ª–∞–≤–Ω—ã–º –º–µ–Ω—é
4. **–ß–∞—Å—Ç–∏—á–Ω–æ –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π** ‚Üí –û–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –Ω—É–∂–Ω—ã–º–∏ –∫–∞–Ω–∞–ª–∞–º–∏
