# –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ë–ê–ì–û–í –ü–û–î–ü–ò–°–û–ö - –î–ï–¢–ê–õ–¨–ù–´–ô –û–¢–ß–ï–¢

## üêõ –ü–†–û–ë–õ–ï–ú–´ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø

1. **–ü—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫ –Ω–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–∞–Ω–∞–ª—ã —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ** - –¥–∞–∂–µ –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–ø–∏—Å–∞–Ω, –±–æ—Ç –ø—Ä–æ—Å–∏—Ç –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è
2. **–ü–æ—Å–ª–µ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–ø–æ–Ω—Å–æ—Ä—Å–∫–∏–µ –∫–∞–Ω–∞–ª—ã** –±–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–∞–Ω–∞–ª—ã, –¥–∞–∂–µ –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –Ω–∞ –Ω–∏—Ö –ø–æ–¥–ø–∏—Å–∞–Ω
3. **–ü—Ä–∏ –∫–æ–º–∞–Ω–¥–µ /start –Ω–µ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º** –±–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å–æ —Å–ø–æ–Ω—Å–æ—Ä—Å–∫–∏–º–∏ –∫–∞–Ω–∞–ª–∞–º–∏, –∞ –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å–ø–æ–Ω—Å–æ—Ä—Å–∫–∏–µ –∫–∞–Ω–∞–ª—ã

## üîç –ù–ê–ô–î–ï–ù–ù–´–ï –ë–ê–ì–ò –ò –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### 1. **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ –ª–æ–≥–∏–∫–µ `getCurrentSubscriptionStage`**

#### –î–û:
```javascript
// –ü–æ–∫–∞ –Ω–µ –º–æ–∂–µ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏ –±–µ–∑ –±–æ—Ç–∞, —Å—á–∏—Ç–∞–µ–º –Ω–µ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–º–∏
const sponsorStatus = {
    allSubscribed: sponsorChannels.length === 0,
    subscribedCount: 0, // ‚ùå –í–°–ï–ì–î–ê 0!
    totalCount: sponsorChannels.length
};

// –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —ç—Ç–∞–ø
if (!sponsorStatus.allSubscribed && sponsorChannels.length > 0) {
    // –í—Å–µ–≥–¥–∞ true –µ—Å–ª–∏ –µ—Å—Ç—å –∫–∞–Ω–∞–ª—ã!
}
```

#### –ü–û–°–õ–ï:
```javascript
// –ü–æ–ª—É—á–∞–µ–º –∫–∞–Ω–∞–ª—ã –ë–ï–ó –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —ç—Ç–∞–ø–∞
const result = {
    sponsorChannels: sponsorChannels,
    requiredChannels: requiredChannels,
    // –≠—Ç–∞–ø—ã –±—É–¥—É—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –ü–û–°–õ–ï —Ä–µ–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ updateSubscriptionStage
    stage: null,
    sponsorStatus: null,
    // ...
};
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** –£–±—Ä–∞–Ω–∞ –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —ç—Ç–∞–ø–æ–≤.

### 2. **–û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ç–∏–ø–æ–≤ –∫–∞–Ω–∞–ª–æ–≤ SubGram**

#### –î–û:
```javascript
// –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞
if (channel.type === 'sponsor' && channel.id.includes('t.me/')) {
    // –ù–æ SubGram –∫–∞–Ω–∞–ª—ã ÔøΩÔøΩ–º–µ—é—Ç type: 'subgram'!
}

// –ò –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–æ–≤
type: 'sponsor', // ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∏–ø
```

#### –ü–û–°–õ–ï:
```javascript
// –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –û–ë–û–ò–• —Ç–∏–ø–æ–≤
if ((channel.type === 'sponsor' || channel.type === 'subgram') && channel.id.includes('t.me/')) {
    const match = channel.id.match(/t\.me\/([^\/\?]+)/);
    if (match) {
        channelToCheck = '@' + match[1];
    }
}

// –ò –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∏–ø
type: 'subgram', // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∏–ø –¥–ª—è SubGram –∫–∞–Ω–∞–ª–æ–≤
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** –¢–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–∞–Ω–∞–ª—ã SubGram.

### 3. **–û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—à–∏–±–æ–∫ –ø–æ–¥–ø–∏—Å–æ–∫**

#### –î–û:
```javascript
} catch (error) {
    return {
        stage: SUBSCRIPTION_STAGES.COMPLETED,
        allCompleted: true, // ‚ùå –ü—Ä–∏ –æ—à–∏–±–∫–µ = "–≤—Å–µ –≥–æ—Ç–æ–≤–æ"!
        // ...
    };
}
```

#### –ü–û–°–õ–ï:
```javascript
} catch (error) {
    return {
        stage: SUBSCRIPTION_STAGES.SPONSORS,
        allCompleted: false, // ‚úÖ –ü—Ä–∏ –æ—à–∏–±–∫–µ = "–Ω—É–∂–Ω—ã –ø–æ–¥–ø–∏—Å–∫–∏"
        sponsorStatus: { allSubscribed: false, subscribedCount: 0, totalCount: 0 },
        // ...
    };
}
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –ø–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –≥–ª–∞–≤–Ω–æ–º—É –º–µ–Ω—é.

### 4. **–£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞–Ω–∞–ª–æ–≤**

#### –î–û:
```javascript
} catch (error) {
    channel.subscribed = true; // –í—Å–µ–≥–¥–∞ –ø–æ–¥–ø–∏—Å–∞–Ω –ø—Ä–∏ –æ—à–∏–±–∫–µ
}
```

#### –ü–û–°–õ–ï:
```javascript
} catch (error) {
    // –î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
    if (channel.type === 'sponsor' || channel.type === 'subgram') {
        channel.subscribed = true; // –°–ø–æ–Ω—Å–æ—Ä—Å–∫–∏–µ - –æ—à–∏–±–∫–∞ = –ø–æ–¥–ø–∏—Å–∞–Ω
    } else {
        channel.subscribed = false; // –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ - —Å—Ç—Ä–æ–∂–µ
    }
}
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** –†–∞–∑–ª–∏—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∫–∞–Ω–∞–ª–æ–≤.

### 5. **–î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö —Å—Å—ã–ª–æ–∫**

#### –ù–û–í–û–ï:
```javascript
// –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ (+–∫–æ–¥)
else if (channel.id.includes('t.me/+')) {
    // –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–µ–ª—å–∑—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ getChatMember
    console.log(`[FLOW] Cannot check private link ${channel.id} - marking as subscribed`);
    channel.subscribed = true;
    return;
}
```

**–î–æ–±–∞–≤–ª–µ–Ω–æ:** –öÔøΩÔøΩ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ –æ—Ç SubGram.

### 6. **–£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞**

#### –î–û–ë–ê–í–õ–ï–ù–û:
```javascript
console.log(`[FLOW] Formatting stage message: stage=${stage}, channelsToShow=${channelsToShow?.length || 0}, allCompleted=${allCompleted}`);

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫–∞–Ω–∞–ª–æ–≤
if (!allCompleted && (!channelsToShow || channelsToShow.length === 0)) {
    console.log(`[FLOW] WARNING: No channels to show for stage ${stage}`);
    return {
        message: 'üîÑ **–ü—Ä–æ–±–ª–µ–º–∞ —Å –∫–∞–Ω–∞–ª–∞–º–∏**\n\n–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞–Ω–∞–ª–æ–≤ –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.',
        buttons: [
            [{ text: 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å', callback_data: 'check_subscriptions' }]
        ]
    };
}
```

**–î–æ–±–∞–≤–ª–µ–Ω–æ:** –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º.

## ‚úÖ –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

### –¢–µ–ø–µ—Ä—å –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ:

#### **–°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç /start**
1. ‚úÖ –ü–æ–ª—É—á–∞—é—Ç—Å—è –∫–∞–Ω–∞–ª—ã –æ—Ç SubGram –∏ –∏–∑ –ë–î
2. ‚úÖ –†–µ–∞–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∏ —á–µ—Ä–µ–∑ Telegram API
3. ÔøΩÔøΩÔøΩ –≠—Ç–∞–ø –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ü–û–°–õ–ï —Ä–µ–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
4. ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –∫–∞–Ω–∞–ª—ã (—Å–ø–æ–Ω—Å–æ—Ä—Å–∫–∏–µ –ò–õ–ò –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ)

#### **–°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ø–æ–Ω—Å–æ—Ä—Å–∫–∏—Ö –∫–∞–Ω–∞–ª–æ–≤**
1. ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —Å—Å—ã–ª–∫–∏ `t.me/username` 
2. ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ —Å—Å—ã–ª–∫–∏ `t.me/+code`
3. ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º –∫–∞–Ω–∞–ª–∞–º

#### **–°—Ü–µ–Ω–∞—Ä–∏–π 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤**
1. ‚úÖ –†–µ–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫
2. ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –ø–æ–¥–ø–∏—Å–æ–∫
3. ‚úÖ –ü–µ—Ä–µ—Ö–æ–¥ –∫ –≥–ª–∞–≤–Ω–æ–º—É –º–µ–Ω—é —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –í–°–ï–• –ø–æ–¥–ø–∏—Å–æ–∫

#### **–°—Ü–µ–Ω–∞—Ä–∏–π 4: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**
1. ‚úÖ –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –ø–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –±–æ—Ç—É
2. ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
3. ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É

## üîß –ò–ó–ú–ï–ù–ï–ù–ù–´–ï –§–ê–ô–õ–´

1. **`subscription-flow-manager.js`** - –æ—Å–Ω–æ–≤–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–æ–≥ÔøΩÔøΩ–∫–∏
2. **–ù–∏–∫–∞–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ `index.js`** - –ª–æ–≥–∏–∫–∞ /start –±—ã–ª–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π

## üéØ –ü–†–û–í–ï–†–ï–ù–û –ò –ò–°–ü–†–ê–í–õ–ï–ù–û

- [x] ‚ùå **–ü—Ä–æ–±–ª–µ–º–∞ 1**: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ ‚Üí ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ**: –†–µ–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ API
- [x] ‚ùå **–ü—Ä–æ–±–ª–µ–º–∞ 2**: –ü–æ–∫–∞–∑ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º ‚Üí ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ**: –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —ç—Ç–∞–ø–æ–≤
- [x] ‚ùå **–ü—Ä–æ–±–ª–µ–º–∞ 3**: –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –≤–º–µ—Å—Ç–æ —Å–ø–æ–Ω—Å–æ—Ä—Å–∫–∏—Ö –∫–∞–Ω–∞–ª–æ–≤ ‚Üí ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ**: –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

## üöÄ –ì–û–¢–û–í–û –ö –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Æ

–ë–æ—Ç —Ç–µ–ø–µ—Ä—å –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–µ:
1. **–°–Ω–∞—á–∞–ª–∞ –¢–û–õ–¨–ö–û —Å–ø–æ–Ω—Å–æ—Ä—Å–∫–∏–µ –∫–∞–Ω–∞–ª—ã**
2. **–ü–æ—Ç–æ–º –¢–û–õ–¨–ö–û –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–∞–Ω–∞–ª—ã** 
3. **–ü–æ—Ç–æ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é**

–ù–∏–∫–∞–∫–∏—Ö —Å–º–µ—à–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤! üéâ
