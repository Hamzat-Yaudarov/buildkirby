# Исправление ошибки ограничения lotteries_ticket_price_check

## Проблема

При попытке создать лотереи типа "Реферальная" и "Авто-реферальная" возникала ошибка:

```
❌ Ошибка создания лотереи: new row for relation "lotteries" violates check constraint "lotteries_ticket_price_check"
```

### Команды, вызывающие ошибку:
- `/create_referral_lottery Реф|168|3|10|1:50|2:30|3:20|4:10`
- `/create_auto_referral_lottery Авто|72|1:100|2:60|3:40`

## Причина

В базе данных было установлено ограничение `CHECK (ticket_price > 0)` на таблице `lotteries`, а код реферальных лотерей устанавливал `ticket_price = 0` для основных билетов, поскольку:

1. **Реферальные лотереи**: основной билет выдается бесплатно при выполнении условия (приглашение рефералов)
2. **Авто-реферальные лотереи**: билеты выдаются автоматически за каждого нового реферала

## Решение

Изменено ограничение с `ticket_price > 0` на `ticket_price >= 0`, чтобы разрешить бесплатные билеты для реферальных лотерей.

### Файлы, которые были изменены:

1. **database-schema.sql** (строка 53):
   ```sql
   -- БЫЛО:
   ticket_price DECIMAL(10,2) NOT NULL CHECK (ticket_price > 0),
   
   -- СТАЛО:
   ticket_price DECIMAL(10,2) NOT NULL CHECK (ticket_price >= 0),
   ```

2. **database.js** (строка 68):
   ```sql
   -- БЫЛО:
   ticket_price DECIMAL(10,2) NOT NULL,
   
   -- СТАЛО:
   ticket_price DECIMAL(10,2) NOT NULL CHECK (ticket_price >= 0),
   ```

3. **Создан скрипт миграции**: `fix-lottery-constraint.js`
   - Удаляет старое ограничение
   - Добавляет новое ограничение `ticket_price >= 0`
   - Тестирует создание лотереи с `ticket_price = 0`

## Результат

✅ **Проблема решена**
- Реферальные лотереи теперь могут быть созданы без ошибок
- Сохранена логика проверки - цена билета не может быть отрицательной
- Обычные лотереи с платными билетами продолжают работать как прежде

## Логика работы реферальных лотерей

### Реферальная лотерея (`referral_condition`):
- Основной билет: бесплатный (при выполнении условия)
- Дополнительные билеты: платные (цена указывается при создании)
- Условие: пригласить N рефералов за указанное время

### Авто-реферальная лотерея (`referral_auto`):
- Билеты: автоматически за каждого нового реферала
- Покупка билетов: недоступна
- Билеты выдаются мгновенно при регистрации нового реферала

## Команды для тестирования

Посл�� исправления можно безопасно использовать:

```bash
# Реферальная лотерея
/create_referral_lottery Недельная|168|3|1.5|1:50|2:30|3:20

# Авто-реферальная лотерея  
/create_auto_referral_lottery Авто|72|1:100|2:60|3:40
```

## Дата исправления

**Исправлено:** $(date)
**Статус:** ✅ Завершено и протестировано
