# üîí –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã –≤—ã–≤–æ–¥–∞

## üìã –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### ‚ùå **–ü—Ä–æ–±–ª–µ–º—ã —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º—ã:**
1. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –æ–¥–Ω—É –∑–∞—è–≤–∫—É** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –º–æ–≥–ª–∏ –ø–æ–¥–∞–≤–∞—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏
2. **–ù–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ –∑–≤—ë–∑–¥** - –∑–≤—ë–∑–¥—ã —Å–ø–∏—Å—ã–≤–∞–ª–∏—Å—å –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –æ—Ç–ø—Ä–∞–≤–∫–∏
3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–∞—â–∏—Ç—ã –æ—Ç –±–∞–≥–æ–≤** - –ø—Ä–∏ –æ—à–∏–±–∫–µ –≤ –∫–æ–¥–µ –∑–≤—ë–∑–¥—ã –º–æ–≥–ª–∏ –±—ã—Ç—å –ø–æ—Ç–µ—Ä—è–Ω—ã

### ‚úÖ **–£–ª—É—á—à–µ–Ω–∏—è –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã:**

#### 1. **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã**
- –£–±—Ä–∞–Ω —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å `idx_unique_pending_withdrawal`
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –ø–æ–¥–∞–≤–∞—Ç—å —Å—Ç–æ–ª—å–∫–æ –∑–∞—è–≤–æ–∫, —Å–∫–æ–ª—å–∫–æ —É –Ω–∏—Ö –µ—Å—Ç—å –∑–≤—ë–∑–¥
- –ö–∞–∂–¥–∞—è –∑–∞—è–≤–∫–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ

#### 2. **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**
```javascript
// –ù–û–í–´–ô –ü–û–†–Ø–î–û–ö:
1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å
2. –°–æ–∑–¥–∞—ë–º –∑–∞—è–≤–∫—É –≤ –ë–î
3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É
4. –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–ø–∏—Å—ã–≤–∞–µ–º –∑–≤—ë–∑–¥—ã
5. –ö–æ–º–º–∏—Ç–∏–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é

// –ü—Ä–∏ –æ—à–∏–±–∫–µ –Ω–∞ –ª—é–±–æ–º —ç—Ç–∞–ø–µ - –æ—Ç–∫–∞—Ç –≤—Å–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
```

#### 3. **–ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ—Ç–µ—Ä–∏ —Å—Ä–µ–¥—Å—Ç–≤**
- **–ü—Ä–∏ –æ—à–∏–±–∫–µ –æ—Ç–ø—Ä–∞–≤–∫–∏** - –∑–≤—ë–∑–¥—ã –ù–ï —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è (–æ—Ç–∫–∞—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
- **–ü—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏** - –∑–≤—ë–∑–¥—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- **–ü—Ä–∏ –æ–¥–æ–±—Ä–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏** - –∑–≤—ë–∑–¥—ã —É–∂–µ —Å–ø–∏—Å–∞–Ω—ã, –≤—ã–ø–ª–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è

#### 4. **–£–ª—É—á—à–µ–Ω–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ**
- –ö–∞–∂–¥–∞—è –∑–∞—è–≤–∫–∞ –∏–º–µ–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
- –í –∞–¥–º–∏–Ω—Å–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –Ω–æ–º–µ—Ä –∑–∞—è–≤–∫–∏
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞–∫ —Å—Ç–∞—Ä–æ–≥–æ, —Ç–∞–∫ –∏ –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ callback'–æ–≤

## üõ°Ô∏è –ú–µ—Ö–∞–Ω–∏–∑–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### **–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –≤ 3 —ç—Ç–∞–ø–∞:**
1. **–î–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏** - –±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. **–í —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π –Ω–∞ —Å–ª—É—á–∞–π concurrent –∑–∞–ø—Ä–æ—Å–æ–≤  
3. **–ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∞–¥–º–∏–Ω–æ–º** - —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –≤—ã–ø–ª–∞—Ç–æ–π

### **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å:**
```sql
BEGIN;
  -- –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏
  -- –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  -- –°–ø–∏—Å–∞–Ω–∏–µ –∑–≤—ë–∑–¥
COMMIT; -- –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—Å—ë —É—Å–ø–µ—à–Ω–æ

-- –ü—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ:
ROLLBACK; -- –û—Ç–∫–∞—Ç –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
```

### **–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –∑–∞—è–≤–æ–∫:**
```javascript
// –ü—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏:
1. –ù–∞—Ö–æ–¥–∏–º –∑–∞—è–≤–∫—É –ø–æ ID
2. –ü–æ–ª—É—á–∞–µ–º —Å—É–º–º—É –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞
3. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ 'rejected'
4. –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ä–µ–¥—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
5. –ö–æ–º–º–∏—Ç–∏–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–º–µ—Å—Ç–µ
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

–°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç `test-withdrawal-security.js` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:
- ‚úÖ –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è
- ‚úÖ –°—Ä–µ–¥—Å—Ç–≤–∞ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏  
- ‚úÖ –ó–∞—è–≤–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–¥–æ–±—Ä—è—é—Ç—Å—è
- ‚úÖ –ù–µ—Ç –ø–æ—Ç–µ—Ä–∏ —Å—Ä–µ–¥—Å—Ç–≤ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤:
```bash
node test-withdrawal-security.js
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã

### **–õ–æ–≥–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:**
- `[WITHDRAWAL] Request created safely` - –∑–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ
- `[WITHDRAWAL] Error in transaction` - –æ—à–∏–±–∫–∞ —Å –æ—Ç–∫–∞—Ç–æ–º
- `[REJECTION] Withdrawal rejected` - –∑–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º —Å—Ä–µ–¥—Å—Ç–≤

### **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –≤ –ë–î:**
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞—è–≤–∫–∏ –±–µ–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Å–ø–∏—Å–∞–Ω–∏–π:
SELECT * FROM withdrawal_requests 
WHERE status = 'completed' 
AND created_at > NOW() - INTERVAL '24 hours';

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
SELECT id, balance FROM users WHERE balance < 0;
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - –∫–æ–¥ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–∞–∫ —Å—Ç–∞—Ä—ã–µ, —Ç–∞–∫ –∏ –Ω–æ–≤—ã–µ –∑–∞—è–≤–∫–∏
2. **–ù–µ—Ç –ø–æ—Ç–µ—Ä—å –¥–∞–Ω–Ω—ã—Ö** - –≤—Å–µ —Å—Ç–∞—Ä—ã–µ –∑–∞—è–≤–∫–∏ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø—Ä–µ–≤—ã—à–µ –≤—Å–µ–≥–æ** - –ª—É—á—à–µ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞—è–≤–∫—É, —á–µ–º –ø–æ—Ç–µ—Ä—è—Ç—å –¥–µ–Ω—å–≥–∏
4. **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å** - –∫–∞–∂–¥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ ID

## üöÄ –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç:**
- –ü–æ–¥–∞–≤–∞—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–≤–æ–¥
- –ë—ã—Ç—å —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ –∏—Ö –∑–≤—ë–∑–¥—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- –ü–æ–ª—É—á–∞—Ç—å –æ–±—Ä–∞—Ç–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤–∞ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –∑–∞—è–≤–æ–∫

‚úÖ **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –ø–æ–ª—É—á–∏–ª–∏:**
- –ü–æ–ª–Ω—É—é –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞—è–≤–æ–∫
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏
- –ó–∞—â–∏—Ç—É –æ—Ç –ø–æ—Ç–µ—Ä–∏ —Å—Ä–µ–¥—Å—Ç–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

‚úÖ **–°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–ª–∞:**
- –ë–æ–ª–µ–µ –Ω–∞–¥—ë–∂–Ω–æ–π –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π
- –ë–æ–ª–µ–µ —É–¥–æ–±–Ω–æ–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π  
- –ë–æ–ª–µ–µ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ–π –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏

---
*–°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! üéâ*
